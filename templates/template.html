<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e0e0e0;
            --hover: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 80px;
            line-height: 1.5;
        }

        /* Layout Architecture */
        .header {
            background: var(--card-bg);
            padding: 24px 0;
            border-bottom: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header h1 { margin: 0 0 8px 0; color: var(--primary); font-size: 1.8rem; }
        .header p { margin: 0; color: var(--text-sub); }

        .container {
            display: flex;
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            gap: 30px;
            align-items: flex-start;
        }

        .main-content { flex: 1; min-width: 0; }

        /* Sidebar: Sticky Guidelines */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            top: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            max-height: calc(100vh - 60px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .sidebar-header h3 { margin: 0; color: var(--primary); }

        .sidebar-content { padding: 20px; }
        
        .guide-item { margin-bottom: 24px; }
        .guide-item:last-child { margin-bottom: 0; }
        .guide-title { font-weight: 700; color: var(--primary); display: block; margin-bottom: 8px; font-size: 0.95rem; }
        .guide-text { font-size: 0.9rem; color: var(--text-sub); }
        .guide-text ul { padding-left: 20px; margin: 8px 0; }

        /* Card System */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 40px;
        }

        /* [Modified] Header Row for Title and Break Button */
        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .card-header-row h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.25rem;
        }

        /* [New] Break Button Style */
        .btn-break {
            background: transparent;
            border: 1px solid #ced4da;
            color: #6c757d;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-break:hover {
            background: #e9ecef;
            color: #495057;
            border-color: #adb5bd;
        }

        /* [New] Rest Overlay Style */
        #rest-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.96);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .rest-content h2 { color: var(--primary); font-size: 2rem; margin-bottom: 10px; }
        .rest-content p { color: var(--text-sub); font-size: 1.2rem; margin-bottom: 30px; }
        .btn-resume {
            padding: 12px 30px;
            font-size: 1.1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: transform 0.2s;
        }
        .btn-resume:hover { background: #2980b9; transform: scale(1.05); }

        /* Audio Player Styling */
        .audio-wrapper {
            background: #f1f3f5;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        audio { width: 100%; height: 40px; outline: none; }

        /* Captions Grid Layout (2x2) */
        .captions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        .caption-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.2s;
            position: relative;
        }

        .caption-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #ced4da;
        }

        /* Distinct tag for visual separation */
        .caption-tag {
            position: absolute;
            top: -10px;
            left: 15px;
            background: var(--accent);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Typography improvements */
        .caption-text {
            font-size: 1rem;
            font-weight: 400; /* Regular weight */
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 20px;
            min-height: 60px; /* Align heights roughly */
        }

        /* Rating Scale Improvements */
        .rating-container {
            border-top: 1px solid #f0f0f0;
            padding-top: 15px;
        }

        .rating-header {
            display: flex;
            justify-content: space-between;
            padding-left: 120px; /* Space for label */
            margin-bottom: 8px;
            color: var(--text-sub);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .rating-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            transition: background-color 0.3s ease; /* For error highlighting */
            border-radius: 4px; /* For error highlighting */
        }
        
        .rating-row:last-child { margin-bottom: 0; }

        .metric-label {
            width: 120px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            flex-shrink: 0;
        }

        .scale {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 4px;
        }

        .radio-wrapper {
            position: relative;
            flex: 1;
            text-align: center;
        }

        .radio-wrapper input {
            cursor: pointer;
            width: 16px;
            height: 16px;
            margin: 0;
            vertical-align: middle;
        }
        
        .radio-wrapper label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-top: 2px;
            cursor: pointer;
        }

        /* Forms */
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--primary); }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; }

        /* Button Styling Update */
        .btn-submit {
            display: block;
            width: 100%;
            padding: 16px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2);
            transition: transform 0.1s, background 0.2s;
        }
        .btn-submit:hover { background: #27ae60; transform: translateY(-1px); }
        .btn-submit:active { transform: translateY(1px); }

        .btn-group {
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin-top: 40px; 
            flex-wrap: wrap;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 1100px) {
            .captions-grid { grid-template-columns: 1fr; } /* Stack on smaller screens */
        }
        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; position: static; max-height: none; margin-bottom: 30px; }
            .rating-header { display: none; } /* Hide complicated header on mobile */
            .rating-row { flex-direction: column; align-items: flex-start; gap: 8px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
            .scale { width: 100%; }
        }
    </style>
</head>
<body>

<header class="header">
    <h1>{{ title }}</h1>
    <p>{{ description }}</p>
</header>

<div class="container">
    <main class="main-content">
        
        <div class="card" id="user-info">
            <h3>Participant Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Age Group</label>
                    <select id="user_age" class="form-control">
                        <option value="" disabled selected>Select age...</option>
                        {% for age in demographics.age_ranges %}<option value="{{ age }}">{{ age }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="user_gender" class="form-control">
                        <option value="" disabled selected>Select gender...</option>
                        {% for g in demographics.genders %}<option value="{{ g }}">{{ g }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Native Language</label>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-top:8px;">
                    {% for lang in demographics.languages %}
                    <label style="font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                        <input type="radio" name="native_lang" value="{{ lang }}" onchange="toggleOther(false)"> {{ lang }}
                    </label>
                    {% endfor %}
                    <label style="font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                        <input type="radio" name="native_lang" value="Others" onchange="toggleOther(true)"> Others
                    </label>
                </div>
                <input type="text" id="other_lang_input" class="form-control" style="margin-top:10px; display:none;" placeholder="Please specify your language">
            </div>
        </div>

        {% for q in questions %}
        <div class="card test-item" data-audio-id="{{ q.id }}">
            
            <div class="card-header-row">
                <h3>{{ q.label }}</h3>
                <button class="btn-break" onclick="triggerRestMode(this)" title="Save progress and take a break">
                    ☕ Save & Break
                </button>
            </div>
            
            <div class="audio-wrapper">
                <audio controls preload="none">
                    <source src="{{ q.src }}" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
            </div>

            <div class="captions-grid">
                {% for cap in q.captions %}
                <div class="caption-card" data-caption-id="{{ cap.id }}" data-caption-text="{{ cap.text }}">
                    <span class="caption-tag">Option {{ loop.index }}</span>
                    <div class="caption-text">{{ cap.text }}</div>
                    
                    <div class="rating-container">
                        <div class="rating-header">
                            <span>Poor</span><span>Excellent</span>
                        </div>
                        
                        {% for metric in evaluation_metrics %}
                        <div class="rating-row">
                            <span class="metric-label">{{ metric }}</span>
                            <div class="scale">
                                {% for i in range(1, 6) %}
                                <div class="radio-wrapper">
                                    <input type="radio" name="{{ q.id }}_{{ cap.id }}_{{ metric }}" value="{{ i }}">
                                    <label>{{ i }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <div class="btn-group">
            <button class="btn-submit" onclick="exportCSV()" style="margin: 0; flex: 2;">Submit Evaluation</button>
            
            <button onclick="saveProgress(); exportDraftCSV(); alert('Draft saved locally and CSV downloaded! You can resume later.');" 
                    title="Save your current answers locally to finish later and download a backup CSV"
                    style="padding: 16px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1; transition: background 0.2s;">
                Save Draft
            </button>
            
            <button onclick="clearProgress()" 
                    title="Delete all answers and start from scratch"
                    style="padding: 16px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; flex: 0.5; transition: background 0.2s;">
                Start Over
            </button>
        </div>

    </main>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>Guidelines</h3>
        </div>
        <div class="sidebar-content">
            {% for section in guideline_sections %}
            <div class="guide-item">
                <span class="guide-title">{{ section.title }}</span>
                <div class="guide-text">
                    {{ section.content }} 
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>
</div>

<div id="rest-overlay">
    <div class="rest-content">
        <div style="font-size: 4rem; margin-bottom: 10px;">☕</div>
        <h2>Take a Break</h2>
        <p>Your progress has been safely saved.<br>Relax your ears and eyes. We'll be here when you're ready.</p>
        <button class="btn-resume" onclick="closeRestMode()">I'm Ready to Continue</button>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const DEBUG_MODE = 0; // Set to 1 to skip validation
    const STORAGE_KEY = 'mos_eval_session_v1'; // Unique key for localStorage

    const sessionID = 'S_' + Math.random().toString(36).substr(2, 9).toUpperCase();

    // ==========================================
    // UTILITIES
    // ==========================================

    function toggleOther(show) {
        document.getElementById('other_lang_input').style.display = show ? 'block' : 'none';
    }

    // Auto-pause others when playing one
    document.addEventListener('play', function(e){
        var audios = document.getElementsByTagName('audio');
        for(var i = 0; i < audios.length; i++){
            if(audios[i] != e.target) audios[i].pause();
        }
    }, true);

    // ==========================================
    // REST MODE LOGIC (NEW)
    // ==========================================

    function triggerRestMode(btnElement) {
        // 1. Save Progress
        saveProgress();
        
        // 2. Visual Feedback
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = "✅ Saved!";
        
        // 3. Show Overlay after delay
        setTimeout(() => {
            document.getElementById('rest-overlay').style.display = 'flex';
            btnElement.innerHTML = originalText;
            document.body.style.overflow = 'hidden'; // Disable scroll
        }, 300);
    }

    function closeRestMode() {
        document.getElementById('rest-overlay').style.display = 'none';
        document.body.style.overflow = 'auto'; // Enable scroll
    }

    // ==========================================
    // SAVE & LOAD LOGIC
    // ==========================================

    function saveProgress() {
        const progress = {
            userInfo: {
                age: document.getElementById('user_age').value,
                gender: document.getElementById('user_gender').value,
                langRadio: document.querySelector('input[name="native_lang"]:checked')?.value,
                langOther: document.getElementById('other_lang_input').value
            },
            ratings: {}
        };

        // Save all checked radio buttons
        document.querySelectorAll('.rating-row input[type="radio"]:checked').forEach(input => {
            progress.ratings[input.name] = input.value;
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
    }

    function loadProgress() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) return;

        try {
            const progress = JSON.parse(savedData);

            // Restore User Info
            if (progress.userInfo) {
                if (progress.userInfo.age) document.getElementById('user_age').value = progress.userInfo.age;
                if (progress.userInfo.gender) document.getElementById('user_gender').value = progress.userInfo.gender;
                
                if (progress.userInfo.langRadio) {
                    const radio = document.querySelector(`input[name="native_lang"][value="${progress.userInfo.langRadio}"]`);
                    if (radio) {
                        radio.checked = true;
                        toggleOther(progress.userInfo.langRadio === 'Others');
                    }
                }
                if (progress.userInfo.langOther) {
                    document.getElementById('other_lang_input').value = progress.userInfo.langOther;
                }
            }

            // Restore Ratings
            if (progress.ratings) {
                for (const [name, value] of Object.entries(progress.ratings)) {
                    const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                }
            }
        } catch (e) {
            console.error("Error loading progress:", e);
        }
    }

    function clearProgress() {
        // [Modified] Warning Text
        if (confirm("⚠️ Are you sure you want to START OVER?\n\nThis will delete all your current answers and you will have to start from the beginning.")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // ==========================================
    // EXPORT & VALIDATION (SUBMIT)
    // ==========================================

    function exportCSV() {
            const age = document.getElementById('user_age').value;
            const gender = document.getElementById('user_gender').value;
            let lang = document.querySelector('input[name="native_lang"]:checked')?.value;
            if (lang === 'Others') lang = document.getElementById('other_lang_input').value || 'Others';

            // 1. Participant Info Validation
            if (!DEBUG_MODE) {
                if (!age || !gender || !lang) {
                    alert("Please complete the Participant Information section at the top.");
                    document.getElementById('user-info').scrollIntoView({behavior:"smooth", block: "center"});
                    return;
                }
            }

            let csv = "SessionID,Age,Gender,Language,AudioID,CaptionID,CaptionText,Metric,Score,Timestamp\n";
            let firstMissingElement = null;
            let missingDetails = ""; 
            let csvRows = [];
            
            // Reset styles
            document.querySelectorAll('.rating-row').forEach(row => {
                row.style.backgroundColor = "";
                row.style.border = "";
            });

            // 2. Data Collection & Rating Validation
            const captionCards = document.querySelectorAll('.caption-card');
            
            for (const block of captionCards) {
                const audioID = block.closest('.test-item').getAttribute('data-audio-id');
                const capID = block.getAttribute('data-caption-id');
                const capText = block.getAttribute('data-caption-text').replace(/,/g, ';').replace(/"/g, "'").replace(/\n/g, " ");
                const optionTag = block.querySelector('.caption-tag').innerText; 

                const ratingRows = block.querySelectorAll('.rating-row');
                
                for (const row of ratingRows) {
                    const metricLabel = row.querySelector('.metric-label').innerText;
                    const checked = row.querySelector('input[type="radio"]:checked');
                    
                    if (!checked && !DEBUG_MODE) {
                        console.log(`Validation Failed at: Audio=${audioID}, Caption=${capID}, Metric=${metricLabel}`);
                        
                        if (!firstMissingElement) {
                            firstMissingElement = row;
                            missingDetails = `Audio: ${audioID}\n${optionTag}\nMetric: ${metricLabel}`;
                        }
                        
                        row.style.backgroundColor = "#ffe6e6"; 
                        row.style.border = "1px solid #ffcccc";
                        
                    } else {
                        const score = checked ? checked.value : "DEBUG_SKIP";
                        const time = new Date().toISOString();
                        csvRows.push(`${sessionID},${age},${gender},${lang},${audioID},${capID},"${capText}",${metricLabel},${score},${time}\n`);
                    }
                }
            }

            // 3. Handle Missing Items with NEW INSTRUCTION
            if (firstMissingElement && !DEBUG_MODE) {
                alert(
                    `⚠️ You have unanswered questions!\n\n` + 
                    `NOTE: If the error persists please click the 'Save Draft' button to download and submit your result file.\n` + 
                    `First missing item:\n${missingDetails}\n\n` +
                    `(Look for the RED highlighted rows)\n\n` +
                );
                
                firstMissingElement.scrollIntoView({behavior: "smooth", block: "center"});
                return; 
            }

            // 4. Finalize Export
            csv += csvRows.join("");
            
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = `eval_results_${sessionID}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            localStorage.removeItem(STORAGE_KEY);
        }
    // ==========================================
    // [NEW] DRAFT EXPORT FUNCTION (NO VALIDATION)
    // ==========================================
    function exportDraftCSV() {
        // Attempt to get user info, default to "Not_Provided" if missing
        const age = document.getElementById('user_age').value || "Not_Provided";
        const gender = document.getElementById('user_gender').value || "Not_Provided";
        let lang = document.querySelector('input[name="native_lang"]:checked')?.value;
        if (lang === 'Others') lang = document.getElementById('other_lang_input').value;
        if (!lang) lang = "Not_Provided";

        let csv = "SessionID,Age,Gender,Language,AudioID,CaptionID,CaptionText,Metric,Score,Timestamp\n";
        let csvRows = [];
        
        const captionCards = document.querySelectorAll('.caption-card');
        
        for (const block of captionCards) {
            const audioID = block.closest('.test-item').getAttribute('data-audio-id');
            const capID = block.getAttribute('data-caption-id');
            const capText = block.getAttribute('data-caption-text').replace(/,/g, ';').replace(/"/g, "'").replace(/\n/g, " ");

            const ratingRows = block.querySelectorAll('.rating-row');
            
            for (const row of ratingRows) {
                const metricLabel = row.querySelector('.metric-label').innerText;
                const checked = row.querySelector('input[type="radio"]:checked');
                
                // NO VALIDATION: Store 'NaN' if missing
                const score = checked ? checked.value : "NaN";
                const time = new Date().toISOString();
                
                csvRows.push(`${sessionID},${age},${gender},${lang},${audioID},${capID},"${capText}",${metricLabel},${score},${time}\n`);
            }
        }

        csv += csvRows.join("");
        
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        // Filename includes _DRAFT suffix
        link.download = `eval_results_${sessionID}_DRAFT.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================

    // Load progress on startup
    window.addEventListener('load', loadProgress);

    // Auto-save on any input change
    document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
            saveProgress();
        }
    });

</script>
</body>
</html>